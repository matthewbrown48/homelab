version: '3.8'

# Pi 5 - Open Media Vault Supplementary Services
# This runs alongside your existing OMV installation
# OMV continues to run on the host system

networks:
  homelab:
    name: ${HOMELAB_NETWORK:-homelab-network}
    driver: bridge

services:
  # Portainer - Container Management UI
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - homelab
    ports:
      - "${PORTAINER_PORT:-9443}:9443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    environment:
      - TZ=${TZ:-UTC}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9000"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Homepage - Dashboard for all services
  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    restart: unless-stopped
    networks:
      - homelab
    ports:
      - "${HOMEPAGE_PORT:-3000}:3000"
    volumes:
      - ./config/homepage:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - TZ=${TZ:-UTC}
      - PUID=1000
      - PGID=1000
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Duplicati - Automated Backups
  duplicati:
    image: lscr.io/linuxserver/duplicati:latest
    container_name: duplicati
    restart: unless-stopped
    networks:
      - homelab
    ports:
      - "${DUPLICATI_PORT:-8200}:8200"
    volumes:
      - duplicati_config:/config
      - ${OMV_BACKUPS_PATH:-/srv/backups}:/backups
      - ${OMV_DATA_PATH:-/srv/data}:/source/data:ro
      - /etc:/source/etc:ro  # Backup system configs
    environment:
      - TZ=${TZ:-UTC}
      - PUID=1000
      - PGID=1000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8200"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Tailscale - Secure Remote Access
  tailscale:
    image: tailscale/tailscale:latest
    container_name: tailscale
    restart: unless-stopped
    network_mode: host
    privileged: true
    volumes:
      - tailscale_data:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTHKEY}
      - TS_HOSTNAME=${TAILSCALE_HOSTNAME:-homelab-pi5}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
    cap_add:
      - NET_ADMIN
      - SYS_MODULE

  # Watchtower - Automatic Container Updates
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    networks:
      - homelab
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=${TZ:-UTC}
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_SCHEDULE=${WATCHTOWER_SCHEDULE:-0 0 4 * * *}
      - WATCHTOWER_NOTIFICATIONS=shoutrrr
      # Optional: Add notification URL (Discord, Slack, etc.)
      # - WATCHTOWER_NOTIFICATION_URL=discord://token@channel

  # Glances - System Monitoring
  glances:
    image: nicolargo/glances:latest
    container_name: glances
    restart: unless-stopped
    privileged: true
    network_mode: host
    pid: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /run/user/1000/podman/podman.sock:/run/user/1000/podman/podman.sock:ro
    environment:
      - GLANCES_OPT=-w
      - TZ=${TZ:-UTC}

volumes:
  portainer_data:
    name: portainer_data
  duplicati_config:
    name: duplicati_config
  tailscale_data:
    name: tailscale_data

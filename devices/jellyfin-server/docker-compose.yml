version: '3.8'

# Jellyfin Media Server Stack
# Includes Jellyfin, Jellyseerr, Traefik reverse proxy

networks:
  homelab:
    name: ${HOMELAB_NETWORK:-homelab-network}
    driver: bridge
  traefik:
    name: traefik-network
    driver: bridge

volumes:
  jellyfin_config:
    name: jellyfin_config
  jellyfin_cache:
    name: jellyfin_cache
  jellyseerr_config:
    name: jellyseerr_config
  transmission_config:
    name: transmission_config
  traefik_acme:
    name: traefik_acme
  tailscale_data:
    name: tailscale_data_jellyfin

services:
  # Traefik - Reverse Proxy with SSL
  traefik:
    image: traefik:v2.10
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - traefik
      - homelab
    ports:
      - "${TRAEFIK_HTTP_PORT:-80}:80"
      - "${TRAEFIK_HTTPS_PORT:-443}:443"
      - "${TRAEFIK_DASHBOARD_PORT:-8080}:8080"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/traefik/traefik.yml:/traefik.yml:ro
      - ./config/traefik/dynamic:/dynamic:ro
      - traefik_acme:/acme
    environment:
      - TZ=${TZ:-UTC}
    command:
      - "--api.insecure=true"
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/dynamic"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.email=${LETSENCRYPT_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/acme/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
    labels:
      - "traefik.enable=true"
      # Redirect HTTP to HTTPS
      - "traefik.http.routers.http-catchall.rule=hostregexp(`{host:.+}`)"
      - "traefik.http.routers.http-catchall.entrypoints=web"
      - "traefik.http.routers.http-catchall.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

  # Jellyfin - Media Server
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    networks:
      - traefik
      - homelab
    ports:
      - "${JELLYFIN_PORT:-8096}:8096"
      - "${JELLYFIN_HTTPS_PORT:-8920}:8920"
      - "7359:7359/udp"  # Allow clients to discover Jellyfin
      - "1900:1900/udp"  # Service discovery
    volumes:
      - jellyfin_config:/config
      - jellyfin_cache:/cache
      - ${MEDIA_MOVIES:-./media/movies}:/media/movies:ro
      - ${MEDIA_TV:-./media/tv}:/media/tv:ro
      - ${MEDIA_MUSIC:-./media/music}:/media/music:ro
    environment:
      - TZ=${TZ:-UTC}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    # Uncomment for hardware transcoding (if supported)
    # devices:
    #   - /dev/dri:/dev/dri  # Intel/AMD GPU
    #   - /dev/vchiq:/dev/vchiq  # Raspberry Pi GPU
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyfin.rule=Host(`${JELLYFIN_SUBDOMAIN:-jellyfin}.${DOMAIN}`)"
      - "traefik.http.routers.jellyfin.entrypoints=websecure"
      - "traefik.http.routers.jellyfin.tls.certresolver=letsencrypt"
      - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Jellyseerr - Media Request Management
  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    restart: unless-stopped
    networks:
      - traefik
      - homelab
    ports:
      - "${JELLYSEERR_PORT:-5055}:5055"
    volumes:
      - jellyseerr_config:/app/config
    environment:
      - TZ=${TZ:-UTC}
      - LOG_LEVEL=info
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyseerr.rule=Host(`${JELLYSEERR_SUBDOMAIN:-requests}.${DOMAIN}`)"
      - "traefik.http.routers.jellyseerr.entrypoints=websecure"
      - "traefik.http.routers.jellyseerr.tls.certresolver=letsencrypt"
      - "traefik.http.services.jellyseerr.loadbalancer.server.port=5055"
    depends_on:
      - jellyfin

  # Transmission - Download Client (Optional)
  transmission:
    image: lscr.io/linuxserver/transmission:latest
    container_name: transmission
    restart: unless-stopped
    networks:
      - traefik
      - homelab
    ports:
      - "${TRANSMISSION_PORT:-9091}:9091"
      - "51413:51413"
      - "51413:51413/udp"
    volumes:
      - transmission_config:/config
      - ${DOWNLOADS_PATH:-./downloads}:/downloads
      - ${MEDIA_MOVIES:-./media/movies}:/media/movies
      - ${MEDIA_TV:-./media/tv}:/media/tv
    environment:
      - TZ=${TZ:-UTC}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - USER=${TRANSMISSION_USER:-admin}
      - PASS=${TRANSMISSION_PASS}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.transmission.rule=Host(`transmission.${DOMAIN}`)"
      - "traefik.http.routers.transmission.entrypoints=websecure"
      - "traefik.http.routers.transmission.tls.certresolver=letsencrypt"
      - "traefik.http.services.transmission.loadbalancer.server.port=9091"

  # Tailscale - Secure Remote Access
  tailscale:
    image: tailscale/tailscale:latest
    container_name: tailscale
    restart: unless-stopped
    network_mode: host
    privileged: true
    volumes:
      - tailscale_data:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTHKEY}
      - TS_HOSTNAME=${TAILSCALE_HOSTNAME:-jellyfin-server}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
    cap_add:
      - NET_ADMIN
      - SYS_MODULE

  # Watchtower - Auto-update containers
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower-media
    restart: unless-stopped
    networks:
      - homelab
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=${TZ:-UTC}
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_SCHEDULE=0 0 3 * * *
      - WATCHTOWER_INCLUDE_STOPPED=false
